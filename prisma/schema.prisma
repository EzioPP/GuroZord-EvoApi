// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider      = "prisma-client"
  output        = "../generated/prisma"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["public", "gurozord"] // Esquemas a serem usados
}

model Member {
  memberId       Int          @id @default(autoincrement()) @map("id")
  whatsappId     String       @unique @map("whatsapp_id")
  whatsappLid    String?      @unique @map("whatsapp_lid")
  whatsappNumber String       @map("whatsapp_number")
  name           String?
  memberships    Membership[]

  @@map("members")
  @@schema("public")
}

model Membership {
  membershipId  Int       @id @default(autoincrement()) @map("id")
  memberId      Int       @map("member_id")
  groupId       Int       @map("group_id")
  isActive      Boolean   @default(true) @map("is_active")
  isAdmin       Boolean   @default(false) @map("is_admin")
  isOwner       Boolean   @default(false) @map("is_owner")
  dtJoined      DateTime  @default(now()) @map("dt_joined")
  dtLeft        DateTime? @map("dt_left")
  dtLastMessage DateTime? @map("dt_last_message")
  messageCount  Int       @default(0) @map("message_count")

  //TODO: add a  status enum (active, left, banned, bannedbybot etc) and deprecate isActive, using it we can measure how many people the bot has banned
  member   Member    @relation(fields: [memberId], references: [memberId])
  group    Group     @relation(fields: [groupId], references: [groupId])
  warnings Warning[]

  @@unique([memberId, groupId])
  @@map("memberships")
  @@schema("public")
}

model Warning {
  warningId    Int      @id @default(autoincrement()) @map("id")
  membershipId Int      @map("membership_id")
  reason       String
  dtCreated    DateTime @default(now()) @map("dt_created")
  appliedById  Int      @map("applied_by_id") // membership de quem aplicou //0 = sistema

  membership Membership @relation(fields: [membershipId], references: [membershipId])

  @@map("warnings")
  @@schema("public")
}

model Group {
  groupId     Int     @id @default(autoincrement()) @map("id")
  whatsappId  String  @unique @map("whatsapp_id")
  name        String
  description String?

  memberships  Membership[]
  groupConfigs GroupConfig[]

  @@map("groups")
  @@schema("public")
}

model GroupConfig {
  configId    Int      @id @default(autoincrement()) @map("id")
  groupId     Int?     @map("group_id") // null = default
  key         String
  value       String   @db.Text
  description String?
  language    String   @default("pt-br")
  updatedAt   DateTime @updatedAt @map("updated_at")

  group Group? @relation(fields: [groupId], references: [groupId])

  @@unique([groupId, key, language])
  @@map("group_config")
  @@schema("public")
}
