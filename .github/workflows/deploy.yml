name: Implantar no Servidor

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Implantar via SSH com PM2
        uses: appleboy/ssh-action@v1.0.3
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          REDIS_URI: ${{ secrets.REDIS_URI }}
          EVOLUTION_API_URL: ${{ secrets.EVOLUTION_API_URL }}
          AUTHENTICATION_API_KEY: ${{ secrets.AUTHENTICATION_API_KEY }}
          TEST_WHATSAPP_NUMBER: ${{ secrets.TEST_WHATSAPP_NUMBER }}
          SERVER_URL: ${{ secrets.SERVER_URL }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: DATABASE_URL,JWT_SECRET,REDIS_URI,EVOLUTION_API_URL,AUTHENTICATION_API_KEY,TEST_WHATSAPP_NUMBER,SERVER_URL,POSTGRES_USER,POSTGRES_PASSWORD,POSTGRES_DB
          script: |
            set -e

            # Clone or pull
            if [ ! -d /data/GuroZord/.git ]; then
              git clone https://github.com/EzioPP/GuroZord-EvoApi.git /data/GuroZord
            fi
            cd /data/GuroZord
            git pull origin main

            # Write .env file
            printf 'NODE_ENV=production\nSERVER_URL=%s\nAUTHENTICATION_API_KEY=%s\nPOSTGRES_USER=%s\nPOSTGRES_PASSWORD=%s\nPOSTGRES_DB=%s\nDATABASE_ENABLED=true\nDATABASE_PROVIDER=postgresql\nDATABASE_CONNECTION_URI=postgresql://%s:%s@postgres:5432/%s\nDATABASE_SAVE_DATA_INSTANCE=true\nDATABASE_SAVE_DATA_NEW_MESSAGE=true\nDATABASE_SAVE_MESSAGE_UPDATE=true\nDATABASE_SAVE_DATA_CONTACTS=true\nDATABASE_SAVE_DATA_CHATS=true\nDATABASE_URL=%s\nEVOLUTION_API_URL=%s\nTEST_WHATSAPP_NUMBER=%s\nREDIS_URI=%s\nCACHE_REDIS_ENABLED=true\nCACHE_REDIS_URI=redis://redis:6379\nCACHE_REDIS_PREFIX_KEY=evolution\nCACHE_REDIS_SAVE_INSTANCES=true\nCACHE_LOCAL_ENABLED=false\nCONFIG_SESSION_PHONE_VERSION=2.3000.1033840069\n' \
              "$SERVER_URL" "$AUTHENTICATION_API_KEY" "$POSTGRES_USER" "$POSTGRES_PASSWORD" "$POSTGRES_DB" \
              "$POSTGRES_USER" "$POSTGRES_PASSWORD" "$POSTGRES_DB" \
              "$DATABASE_URL" "$EVOLUTION_API_URL" "$TEST_WHATSAPP_NUMBER" "$REDIS_URI" \
              > /data/GuroZord/.env

            # Node setup (build only)
            export NVM_DIR="$HOME/.nvm"
            if [ -s "$NVM_DIR/nvm.sh" ]; then
              . "$NVM_DIR/nvm.sh"
            else
              echo "nvm not found at $NVM_DIR"
              exit 1
            fi
            nvm install 24
            nvm use 24
            npm ci
            npx prisma generate
            npm run build

            # Docker Compose - restart only if compose file changed
            PREV_COMPOSE_HASH=$(cat /data/GuroZord/.compose_hash 2>/dev/null || echo "")
            CURR_COMPOSE_HASH=$(sha256sum docker-compose.yml | awk '{print $1}')
            if [ "$PREV_COMPOSE_HASH" != "$CURR_COMPOSE_HASH" ]; then
              echo "docker-compose.yml changed, restarting services..."
              docker compose down
              docker compose up -d
              echo "$CURR_COMPOSE_HASH" > /data/GuroZord/.compose_hash
            else
              echo "docker-compose.yml unchanged, ensuring services are up..."
              docker compose up -d --no-recreate
            fi

            # Wait for healthy dependencies
            echo "Waiting for postgres and redis to be healthy..."
            timeout 120 bash -c 'until docker inspect --format="{{.State.Health.Status}}" postgres | grep -q healthy; do sleep 2; done'
            timeout 120 bash -c 'until docker inspect --format="{{.State.Health.Status}}" redis | grep -q healthy; do sleep 2; done'

            # Wait for gurozord container
            timeout 120 bash -c 'until docker inspect --format="{{.State.Status}}" gurozord 2>/dev/null | grep -q running; do sleep 2; done'

            # Run migrations inside container
            docker exec gurozord npx prisma migrate deploy