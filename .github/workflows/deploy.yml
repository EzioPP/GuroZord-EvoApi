name: Implantar no Servidor

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Implantar via SSH com PM2
        uses: appleboy/ssh-action@v1.0.3
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          REDIS_URI: ${{ secrets.REDIS_URI }}
          EVOLUTION_API_URL: ${{ secrets.EVOLUTION_API_URL }}
          AUTHENTICATION_API_KEY: ${{ secrets.AUTHENTICATION_API_KEY }}
          TEST_WHATSAPP_NUMBER: ${{ secrets.TEST_WHATSAPP_NUMBER }}
          SERVER_URL: ${{ secrets.SERVER_URL }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: DATABASE_URL,JWT_SECRET,REDIS_URI,EVOLUTION_API_URL,AUTHENTICATION_API_KEY,TEST_WHATSAPP_NUMBER,SERVER_URL,POSTGRES_USER,POSTGRES_PASSWORD,POSTGRES_DB
          script: |
            set -e

            # Clone or pull
            if [ ! -d /data/GuroZorg/.git ]; then
              git clone https://github.com/EzioPP/GuroZord-EvoApi.git  /data/GuroZorg
            fi
            cd /data/GuroZorg
            git pull origin main

            # Write .env file
            cat > /data/GuroZorg/.env << EOF
            NODE_ENV=production

            # Server
            SERVER_URL=${SERVER_URL}

            # Authentication
            AUTHENTICATION_API_KEY=${AUTHENTICATION_API_KEY}

            # PostgreSQL
            POSTGRES_USER=${POSTGRES_USER}
            POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
            POSTGRES_DB=${POSTGRES_DB}

            # Database
            DATABASE_ENABLED=true
            DATABASE_PROVIDER=postgresql
            DATABASE_CONNECTION_URI=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
            DATABASE_SAVE_DATA_INSTANCE=true
            DATABASE_SAVE_DATA_NEW_MESSAGE=true
            DATABASE_SAVE_MESSAGE_UPDATE=true
            DATABASE_SAVE_DATA_CONTACTS=true
            DATABASE_SAVE_DATA_CHATS=true

            DATABASE_URL=${DATABASE_URL}

            # Evolution
            EVOLUTION_API_URL=${EVOLUTION_API_URL}

            # Prisma
            TEST_WHATSAPP_NUMBER=${TEST_WHATSAPP_NUMBER}

            # Redis
            REDIS_URI=${REDIS_URI}
            CACHE_REDIS_ENABLED=true
            CACHE_REDIS_URI=redis://redis:6379
            CACHE_REDIS_PREFIX_KEY=evolution
            CACHE_REDIS_SAVE_INSTANCES=true
            CACHE_LOCAL_ENABLED=false

            CONFIG_SESSION_PHONE_VERSION=2.3000.1033840069
            EOF

            # Docker Compose - restart only if compose file changed
            PREV_COMPOSE_HASH=$(cat /data/GuroZorg/.compose_hash 2>/dev/null || echo "")
            CURR_COMPOSE_HASH=$(sha256sum docker-compose.yml | awk '{print $1}')
            if [ "$PREV_COMPOSE_HASH" != "$CURR_COMPOSE_HASH" ]; then
              echo "docker-compose.yml changed, restarting services..."
              docker compose down
              docker compose up -d
              echo "$CURR_COMPOSE_HASH" > /data/GuroZorg/.compose_hash
            else
              echo "docker-compose.yml unchanged, ensuring services are up..."
              docker compose up -d --no-recreate
            fi

            # Wait for healthy dependencies
            echo "Waiting for postgres and redis to be healthy..."
            timeout 60 bash -c 'until docker inspect --format="{{.State.Health.Status}}" postgres | grep -q healthy; do sleep 2; done'
            timeout 60 bash -c 'until docker inspect --format="{{.State.Health.Status}}" redis | grep -q healthy; do sleep 2; done'

            # Node setup
            export NVM_DIR="$HOME/.nvm"
            if [ -s "$NVM_DIR/nvm.sh" ]; then
              . "$NVM_DIR/nvm.sh"
            else
              echo "nvm not found at $NVM_DIR"
              exit 1
            fi
            nvm install 24
            nvm use 24
            npm ci
            npm run build
            npx prisma migrate deploy

            # PM2
            if pm2 describe gurozorg > /dev/null 2>&1; then
              pm2 restart ecosystem.config.js --update-env
            else
              pm2 start ecosystem.config.js --env production
            fi
            pm2 save